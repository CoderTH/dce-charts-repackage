{{- if .Values.crd_conf -}}
{{- range $cni, $conf := .Values.crd_conf -}}
{{- if $conf.enable }}
---
apiVersion: "k8s.cni.cncf.io/v1"
kind: NetworkAttachmentDefinition
metadata:
  name: {{ $conf.name }}
  namespace: kube-system
  annotations:
    {{- include "multus-underlay.helm-hook-annotations" . | nindent 4 }}
{{- if $conf.default_cni }}
    daocloud.io.multus/default-cni: {{ $conf.name }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
---
{{- if .Values.underlay_crds.macvlan.macvlan_standalone.enable }}
# 1 macvlan-standalone
apiVersion: "k8s.cni.cncf.io/v1"
kind: NetworkAttachmentDefinition
metadata:
  name: {{ .Values.underlay_crds.macvlan.macvlan_standalone.name }}
  namespace: kube-system
  annotations:
    {{- include "multus-underlay.helm-hook-annotations" . | nindent 4 }}
spec:
  config: |-
    {
        "cniVersion": "0.3.1",
        "name": "macvlan-standalone",
        "plugins": [
            {
                "type": "macvlan",
                "master": {{ .Values.underlay_crds.macvlan.master | quote }},
                "mode": "bridge",
                "ipam": {
                    "type": "spiderpool",
                    "log_level": "DEBUG",
                    "log_file_path": "/var/log/spidernet/spiderpool.log",
                    "log_file_max_size": 100,
                    "log_file_max_age": 30,
                    "log_file_max_count": 10
                }
            },{
                "type": "veth",
                "routes": [{"dst": "{{ .Values.underlay_crds.service_subnet.ipv4 }}"}{{ range .Values.underlay_crds.calico_subnet.ipv4 }},{"dst": {{ . | quote }}}{{ end }}{{if .Values.underlay_crds.macvlan.macvlan_standalone.custom_route }},{"dst": "{{ .Values.underlay_crds.macvlan.macvlan_standalone.custom_route }}"}{{ end }}{{ range .Values.underlay_crds.calico_subnet.ipv6 }},{"dst": {{ . | quote }}}{{ end }}{{if .Values.underlay_crds.service_subnet.ipv6 }},{"dst": "{{ .Values.underlay_crds.service_subnet.ipv6 }}"}{{ end }}],
                "rp_filter": {
                    "set_host": {{ .Values.underlay_crds.rp_filter.enable }},
                    "value": {{ .Values.underlay_crds.rp_filter.value }}
                },
                "skip_call": {{ .Values.underlay_crds.macvlan.macvlan_standalone.skip_call }}
            }
        ]
    }
{{- end }}
{{- if .Values.underlay_crds.macvlan.macvlan_overlay.enable }}
---
# 2 macvlan-overlay
apiVersion: "k8s.cni.cncf.io/v1"
kind: NetworkAttachmentDefinition
metadata:
  name: {{ .Values.underlay_crds.macvlan.macvlan_overlay.name }}
  namespace: kube-system
  annotations:
    {{- include "multus-underlay.helm-hook-annotations" . | nindent 4 }}
spec:
  config: |-
    {
        "cniVersion": "0.3.1",
        "name": "macvlan-overlay",
        "plugins": [
            {
                "type": "macvlan",
                "master": {{ .Values.underlay_crds.macvlan.master | quote }},
                "mode": "bridge",
                "ipam": {
                    "type": "spiderpool",
                    "log_level": "DEBUG",
                    "log_file_path": "/var/log/spidernet/spiderpool.log",
                    "log_file_max_size": 100,
                    "log_file_max_age": 30,
                    "log_file_max_count": 10
                }
            },{
                "type": "router",
                "routes": [{"dst": "{{ .Values.underlay_crds.service_subnet.ipv4 }}"}{{ range .Values.underlay_crds.calico_subnet.ipv4 }},{"dst": {{ . | quote }}}{{ end }}{{if .Values.underlay_crds.macvlan.macvlan_overlay.custom_route }},{"dst": "{{ .Values.underlay_crds.macvlan.macvlan_overlay.custom_route }}"}{{ end }}{{if .Values.underlay_crds.service_subnet.ipv6 }},{"dst": "{{ .Values.underlay_crds.service_subnet.ipv6 }}"}{{ end }}{{ range .Values.underlay_crds.nodePortNodeIPs }},{"dst": {{ . | quote }}}{{ end }}],
                "rp_filter": {
                    "set_host": {{ .Values.underlay_crds.rp_filter.enable }},
                    "value": {{ .Values.underlay_crds.rp_filter.value }}
                },
                "hijack_overlay_reponse": {{ .Values.underlay_crds.macvlan.macvlan_overlay.hijack_overlay_reponse }},
                "overlayInterface": {{ .Values.underlay_crds.macvlan.macvlan_overlay.overlayInterface }},
                "skip_call": {{ .Values.underlay_crds.macvlan.macvlan_overlay.skip_call }}
            }
        ]
    }
{{- end }}
---
{{- if .Values.underlay_crds.sriov.sriov_standalone.enable }}
# 3 sriov-standalone
apiVersion: "k8s.cni.cncf.io/v1"
kind: NetworkAttachmentDefinition
metadata:
  name: {{ .Values.underlay_crds.sriov.sriov_standalone.name }}
  namespace: kube-system
  annotations:
    {{- include "multus-underlay.helm-hook-annotations" . | nindent 4 }}
    k8s.v1.cni.cncf.io/resourceName: {{ required ".Values.underlay_crds.sriov.resourceName must be defined when .Values.underlay_crds.sriov.sriov_standalone.enabled == true" .Values.underlay_crds.sriov.resourceName }}
spec:
  config: |-
    {
        "cniVersion": "0.3.1",
        "name": "sriov-standalone",
        "plugins": [
            {
                "type": "sriov",
                "ipam": {
                    "type": "spiderpool",
                    "log_level": "DEBUG",
                    "log_file_path": "/var/log/spidernet/spiderpool.log",
                    "log_file_max_size": 100,
                    "log_file_max_age": 30,
                    "log_file_max_count": 10
                }
            },{
                "type": "veth",
                "routes": [{"dst": "{{ .Values.underlay_crds.service_subnet.ipv4 }}"}{{ range .Values.underlay_crds.calico_subnet.ipv4 }},{"dst": {{ . | quote }}}{{ end }}{{ range .Values.underlay_crds.calico_subnet.ipv6 }},{"dst": {{ . | quote }}}{{ end }}{{if .Values.underlay_crds.sriov.sriov_standalone.custom_route }},{"dst": "{{ .Values.underlay_crds.sriov.sriov_standalone.custom_route }}"}{{ end }}{{if .Values.underlay_crds.service_subnet.ipv6 }},{"dst": "{{ .Values.underlay_crds.service_subnet.ipv6 }}"}{{ end }}],
                "rp_filter": {
                    "set_host": {{ .Values.underlay_crds.rp_filter.enable }},
                    "value": {{ .Values.underlay_crds.rp_filter.value }}
                },
                "skip_call": {{ .Values.underlay_crds.sriov.sriov_standalone.skip_call }}
            }
        ]
    }
{{- end }}
{{- if .Values.underlay_crds.sriov.sriov_overlay.enable }}
---
# sriov-overlay
apiVersion: "k8s.cni.cncf.io/v1"
kind: NetworkAttachmentDefinition
metadata:
  name: {{ .Values.underlay_crds.sriov.sriov_overlay.name }}
  namespace: kube-system
  annotations:
    {{- include "multus-underlay.helm-hook-annotations" . | nindent 4 }}
    k8s.v1.cni.cncf.io/resourceName: {{ required ".Values.underlay_crds.sriov.resourceName must be defined when .Values.underlay_crds.sriov.sriov_overlay.enabled == true" .Values.underlay_crds.sriov.resourceName }}
spec:
  config: |-
    {
        "cniVersion": "0.3.1",
        "name": "sriov-overlay",
        "plugins": [
            {
                "type": "sriov",
                "ipam": {
                    "type": "spiderpool",
                    "log_level": "DEBUG",
                    "log_file_path": "/var/log/spidernet/spiderpool.log",
                    "log_file_max_size": 100,
                    "log_file_max_age": 30,
                    "log_file_max_count": 10
                }
            },{
                "type": "router",
                "routes": [{"dst": "{{ .Values.underlay_crds.service_subnet.ipv4 }}"}{{if .Values.underlay_crds.sriov.sriov_overlay.custom_route }},{"dst": "{{ .Values.underlay_crds.sriov.sriov_overlay.custom_route }}"}{{ end }}{{if .Values.underlay_crds.service_subnet.ipv6 }},{"dst": "{{ .Values.underlay_crds.service_subnet.ipv6 }}"}{{ end }}{{ range .Values.underlay_crds.calico_subnet.ipv4 }},{"dst": {{ . | quote }}}{{ end }}{{ range .Values.underlay_crds.nodePortNodeIPs }},{"dst": {{ . | quote }}}{{ end }}],
                "rp_filter": {
                    "set_host": {{ .Values.underlay_crds.rp_filter.enable }},
                    "value": {{ .Values.underlay_crds.rp_filter.value }}
                },
                "hijack_overlay_reponse": {{ .Values.underlay_crds.sriov.sriov_overlay.hijack_overlay_reponse }},
                "overlayInterface": {{ .Values.underlay_crds.sriov.sriov_overlay.overlayInterface }},
                "skip_call": {{ .Values.underlay_crds.sriov.sriov_overlay.skip_call }}
            }
        ]
    }
{{- end }}
